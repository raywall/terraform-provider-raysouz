name: Release Terraform Provider

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    #############################################################
    # 1) VALIDAÇÃO
    #############################################################
    validate:
        name: Validate
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: 1.23

            - name: Go fmt
              run: go fmt ./...

            - name: Go vet
              run: go vet ./...

            # - name: Test
            #   run: go test ./... -cover

    #############################################################
    # 2) RELEASE — chama workflow de versão + build + release
    #############################################################
    release:
        name: Release
        needs: validate
        runs-on: ubuntu-latest
        permissions:
            contents: write

        outputs:
            new_tag: ${{ steps.version.outputs.new_tag }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true

            ###########################################################
            # Chamada do workflow de versão reutilizável
            ###########################################################
            - name: Generate Version Tag
              id: version
              uses: ./.github/workflows/create-version-tag.yml

            ###########################################################
            # Build multiplataforma do provider
            ###########################################################
            - name: Build Provider Binaries
              run: |
                  mkdir -p dist
                  VERSION=${{ steps.version.outputs.new_tag }}

                  for os in linux darwin windows; do
                    for arch in amd64 arm64; do
                      GOOS=$os GOARCH=$arch go build -o dist/terraform-provider-raysouz_${VERSION#v}_${os}_${arch}
                    done
                  done

            - name: Zip binaries
              run: |
                  cd dist
                  for f in terraform-provider-raysouz_*; do zip "$f.zip" "$f"; done

            - name: Create SHA256SUMS
              run: |
                  cd dist
                  sha256sum *.zip > SHA256SUMS

            ###########################################################
            # Assinar com GPG
            ###########################################################
            - name: Import GPG key
              uses: crazy-max/ghaction-import-gpg@v6
              with:
                  gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
                  passphrase: ${{ secrets.GPG_PASSPHRASE }}

            - name: Sign checksums
              run: |
                  cd dist
                  gpg --detach-sign SHA256SUMS

            ###########################################################
            # Criar release no GitHub
            ###########################################################
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.version.outputs.new_tag }}
                  files: |
                      dist/*.zip
                      dist/SHA256SUMS
                      dist/SHA256SUMS.sig

    #############################################################
    # 3) PUBLICAÇÃO NO GO PROXY
    #############################################################
    publish_go:
        name: Publish to Go Proxy
        needs: release
        runs-on: ubuntu-latest

        steps:
            - name: Trigger Go Proxy refresh
              run: |
                  curl -s "https://proxy.golang.org/github.com/${{ github.repository }}/@v/${{ needs.release.outputs.new_tag }}.info"

    #############################################################
    # 4) PUBLICAÇÃO NO TERRAFORM REGISTRY
    #############################################################
    publish_terraform:
        name: Publish to Terraform Registry
        needs: [release, publish_go]
        runs-on: ubuntu-latest

        steps:
            - name: Notify Terraform Registry
              run: |
                  curl -X POST https://registry.terraform.io/api/v1/providers/github/${{ github.repository_owner }}/raysouz/versions \
                    -H "Content-Type: application/json" \
                    -d '{"version":"'"${{ needs.release.outputs.new_tag }}"'"}' || true
